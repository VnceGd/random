<!DOCTYPE html>
<!-- Vincent Nguyen 2018 -->
<!-- Snake game based on airicbear's prototype, mixed with elements from dungeon-proto -->
<html>
  <head>
    <title> Snake Game </title>
    <style>
      #board {
        margin-left: 10vmin;
        width: 80vmin;
        height: 80vmin;
      }
      table, tr, td {
        border-collapse: collapse;
        border: 1px solid black;
      }
    </style>
    <script>
      
      // Global variables for handling game state
      let inGame = false
      let inSettings = false
      let paused = true
      let updating
      let keys = {}

      // Objects
      let snake = {
        length: 1,
        x_pos: 0,
        y_pos: 0,
        body: [],
        vel: [0, 0],
        color: 'green'
      }
      
      let apple = {
        pos: [],
        color: 'red'
      }

      let grid = {
        board: [0, 0],
        boardSize: 20,
        bg_color: 'black'
      }

      // Displays debug text on page
      function debug(text) {
        document.getElementById("debugtxt").innerHTML = text
      }
      
      function openSettings() {
        if(!inSettings) {
          inSettings = true
          document.getElementById("settingsMenu").style.display = 'inline'
          document.getElementById("playButton").disabled = true
          document.getElementById("settingsButton").innerHTML = 'Close Settings'
        }
        else {
          inSettings = false
          document.getElementById("settingsMenu").style.display = 'none'
          document.getElementById("playButton").disabled = false
          document.getElementById("settingsButton").innerHTML = 'Settings'
        }
      }
      
      // Generates an html table of specified board size
      function makeBoard() {
        grid.boardSize = document.getElementById("boardSize").value
        let board = ''
        for(let y = 0; y < grid.boardSize; y++) {
          board += '<tr>'
          for(let x = 0; x < grid.boardSize; x++) {
            board += '<td id="' + x + ',' + y + '"></td>'
          }
          board += '</tr>'
          snake.body[y] = null
        }
        document.getElementById("board").innerHTML = board
      }

      // Probably a bad idea: undraw and redraw the entire board state
      function undraw() {

      }
      function draw() {
        let coord = ''
        for(let x = 0; x < snake.body.length; x++) {
          coord = x.toString() + ',' + x.toString()
          document.getElementById(coord).innerHTML = 's'
        }
      }

      // Called by play() to constantly update the game board
      function update() {
        if(inGame && !paused) {
          // undraw()
          turn()
          move()
          // draw()
          console.log("Updated.")
        }
      }

      // Starts the game and sets updating to repeatedly call update()
      function play() {
        console.log("Starting...")
        inGame = true
        paused = false
        document.getElementById("pauseButton").style.display = 'inline'
        document.getElementById("playButton").style.display = 'none'
        document.getElementById("settingsButton").disabled = true
        updating = setInterval(update, 1000)
        makeBoard()
      }
      // Pauses the game
      function pause() {
        clearInterval(updating)
        paused = true
        document.getElementById("pauseButton").style.display = 'none'
        document.getElementById("playButton").style.display = 'inline'
        console.log("Game paused.")
      }
      function move() {
        if(snake.vel[0] === 1) {
          snake.body[snake.xpos + 1] = snake.ypos
        }

      }
      // Changes snake velocity
      function turn() {
        let up = (38 in keys || 87 in keys)
        let down = (40 in keys || 83 in keys)
        let left = (37 in keys || 65 in keys)
        let right = (39 in keys || 68 in keys)
        
        if(!inGame) {
          inGame = true
        }
        if(up && snake.vel[1] !== -1) {
          console.log("Facing up")
          snake.vel = [0, 1]
        }
        else if(down && snake.vel[1] !== 1) {
          console.log("Facing down")
          snake.vel = [0, -1]
        }
        else if(left && snake.vel[0] !== -1) {
          console.log("Facing left")
          snake.vel = [1, 0]
        }
        else if(right && snake.vel[0] !== 1) {
          console.log("Facing right")
          snake.vel = [-1, 0]
        }
      }
      
      // Listens for keypresses
      addEventListener("keydown", function(e) {
        keys[e.keyCode] = true
      }, false)
      addEventListener("keyup", function(e) {
        delete keys[e.keyCode]
      }, false)


    </script>
  </head>
  <body>
    <div id="menu">
      <button id="playButton" onclick="play()">Play</button>
      <button id="pauseButton" onclick="pause()" style="display:none">Pause</button>
      <button id="settingsButton" onclick="openSettings()">Settings</button>
      <div id="settingsMenu" style="display:none">
          <p>Board Size</p>
          <input id="boardSize" type="text" value="20">
      </div>
      <div id="debug">
        <p id="debugtxt"></p>
      </div>
    </div>
    <div id="grid">
      <table id="board">

      </table>
    </div>
  </body>
</html>